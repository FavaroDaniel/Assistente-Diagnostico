<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Assistente – Abortou a Cura (v20)</title>
<style>
:root{
  --bg:#ffffff; --fg:#111; --muted:#6b6b6b;
  --accent:#e63c2f; --panel:#f7f7f8; --header:#2f2f2f; --err:#d93025;
  --br:14px; --space:14px;
  color-scheme: light dark;
}
.dark{
  --bg:#0f1115; --fg:#f2f4f8; --muted:#a7b0bf;
  --panel:#171a21; --header:#0c0f14; --accent:#e63c2f; --err:#ff6b64;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.appbar{position:sticky;top:0;z-index:5;background:var(--header);color:#fff;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{font-weight:900;letter-spacing:.5px}
.container{max-width:980px;margin:0 auto;padding:var(--space)}
.card{background:var(--panel);border-radius:var(--br);padding:16px;border:1px solid #e8e8ef;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:12px}
h1,h2{margin:8px 0 10px 0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:740px){.row{grid-template-columns:1fr}}
.input,.select,.textarea{width:100%;padding:12px 12px;border-radius:10px;border:1px solid #dcdce3;background:#fff;color:var(--fg)}
.dark .input,.dark .select,.dark . textarea{background:#0d0f14;border-color:#303646}
.input.error,.select.error,.textarea.error{border-color:var(--err);box-shadow:0 0 0 3px rgba(217,48,37,.15)}
.textarea{min-height:120px;resize:none}
.btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:11px 16px;border-radius:999px;border:0;background:var(--header);color:#fff;font-weight:700}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.secondary{background:#9aa0a6}
.btn.accent{background:var(--accent)}
.list{display:grid;gap:10px}
.item{background:#fff;border:1px solid #e8e8ef;border-radius:12px;padding:12px}
.dark .item{background:#111520;border-color:#2a2f3a}
.item.error{border-color:var(--err);box-shadow:0 0 0 3px rgba(217,48,37,.12)}
.item .title{font-weight:800}
.item .how{margin-top:6px;color:#333}
.dark .item .how{color:#d8dbe6}
.item .obs{width:100%;min-height:52px;margin-top:8px;border-radius:10px;border:1px solid #ddd;padding:8px;background:#fafafa;resize:none;color:#111}
.dark .item .obs{background:#0d0f14;color:#f2f4f8;border-color:#2a2f3a}
.small{font-size:12px;color:var(--muted)}
.badge{padding:3px 8px;border-radius:999px;background:#eee;color:#333;font-size:12px}
.dark .badge{background:#2a2f3a;color:#e2e6ef}
.progress{height:10px;border-radius:999px;background:#eee;overflow:hidden;margin:8px 0 0}
.dark .progress{background:#2a2f3a}
.progress>span{display:block;height:100%;background:var(--accent);width:0%}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s}
.dark .toast{background:#222835}
.toast.show{opacity:1}
@media print{
  .no-print{display:none !important}
  #printArea{display:block !important}
}
#printArea{display:none}
</style>
</head>
<body>
<div class="appbar no-print">
  <div class="brand">BRIDGESTONE</div>
  <div style="display:flex;gap:8px">
    <button id="btnTheme" class="btn secondary">Tema: Claro</button>
    <button id="btnClear" class="btn secondary" title="Reseta tudo (WO, Técnico, defeito, checklist e resumo)">Limpar</button>
  </div>
</div>

<div class="container no-print">

  <div class="card" id="cardInit">
    <h2>1) Dados iniciais</h2>
    <div class="row">
      <div>
        <label class="small">Nº da WO (ordem de serviço) <span style="color:var(--err)">*</span></label>
        <input id="inpWO" class="input" placeholder="Ex.: 123456">
      </div>
      <div>
        <label class="small">Nome do técnico <span style="color:var(--err)">*</span></label>
        <input id="inpTec" class="input" placeholder="Ex.: João Silva">
      </div>
    </div>

    <h2 style="margin-top:14px">2) Escolha o defeito</h2>
    <select id="selDef" class="select">
      <option value="" selected>— selecione —</option>
      <option>Abortou a Cura</option>
    </select>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
      <button id="btnGo" class="btn">Avançar</button>
    </div>
  </div>

  <div class="card" id="cardChk" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div><strong>Checklist – Abortou a Cura</strong><br><span class="small">Marque OK / NOK / N.A. e registre observações (NOK exige observação)</span></div>
      <div class="badge"><span id="done">0</span>/<span id="total">0</span></div>
    </div>
    <div class="progress"><span id="bar"></span></div>
    <div id="lista" class="list" style="margin-top:10px"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px;flex-wrap:wrap">
      <button id="btnResumo" class="btn accent">Gerar resumo para o BAMM</button>
      <button id="btnPDF" class="btn secondary">Salvar PDF</button>
    </div>
  </div>

  <div class="card" id="cardOut" style="display:none">
    <h2>Resumo</h2>
    <textarea id="out" class="textarea" placeholder="Resumo gerado aqui…"></textarea>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;gap:8px;flex-wrap:wrap">
      <button id="btnCopy" class="btn">Copiar</button>
      <button id="btnReset" class="btn secondary">Novo</button>
    </div>
  </div>

</div>

<div id="printArea">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:800">Assistente de Diagnóstico</div>
    <div style="font-weight:900;letter-spacing:1px">BRIDGESTONE</div>
  </div>
  <div style="font-weight:700" id="phHeader"></div>
  <div id="phDefeito" style="margin:6px 0 4px">Defeito: Abortou a Cura</div>
  <div id="phWO" class="small" style="margin:0 0 2px"></div>
  <div id="phTec" class="small" style="margin:0 0 10px"></div>
  <table style="width:100%;border-collapse:collapse;margin-bottom:10px" border="1" cellpadding="6">
    <thead><tr><th style="width:40%">Passo</th><th style="width:10%">Status</th><th>Observação</th></tr></thead>
    <tbody id="phTable"></tbody>
  </table>
  <div style="font-weight:700;margin-bottom:4px">Resumo para BAMM</div>
  <pre id="phResumo" style="white-space:pre-wrap;margin:0"></pre>
</div>

<div id="toast" class="toast no-print" role="status" aria-live="polite">OK</div>

<script>
var DATA = {"defeitos": ["Abortou a Cura"], "itens_por_defeito": {"Abortou a Cura": [{"PassoOrdem": 1, "OQueVerificar": "Teste de vazamento", "ComoVerificar": "Instalar tampão e executar teste; confirmar se o aborto ocorreu logo após a etapa de vazamento."}, {"PassoOrdem": 2, "OQueVerificar": "Válvula de descarga do shaping", "ComoVerificar": "Checar passagem/obstrução; remover resíduos e garantir acionamento correto."}, {"PassoOrdem": 3, "OQueVerificar": "Condições do bladder", "ComoVerificar": "Verificar se está solto, furado, mal posicionado ou com vedação comprometida."}, {"PassoOrdem": 4, "OQueVerificar": "Anéis e O’rings", "ComoVerificar": "Inspecionar desgaste/cortes e montagem; reinstalar conforme procedimento."}, {"PassoOrdem": 5, "OQueVerificar": "Pressão do ar do timer (≈55 psi)", "ComoVerificar": "Medir no bloco do timer; se baixo, procurar vazamentos na linha."}, {"PassoOrdem": 6, "OQueVerificar": "Solenoides e válvulas 5/2 do timer", "ComoVerificar": "Verificar travamento de carretel/passa-ar; testar acionamentos."}, {"PassoOrdem": 7, "OQueVerificar": "Cartão de saída do timer (CLP)", "ComoVerificar": "Monitorar saídas durante a cura; testar com tampão para falha intermitente."}, {"PassoOrdem": 8, "OQueVerificar": "Mangueiras/tubos do sistema interno", "ComoVerificar": "Inspecionar layout, rachaduras, folgas ou vazamentos; substituir se necessário."}, {"PassoOrdem": 9, "OQueVerificar": "Obstrução em transmissores de pressão", "ComoVerificar": "Conferir leitura; desobstruir linha de sinal e checar conectores."}, {"PassoOrdem": 10, "OQueVerificar": "Sistema de segurança/acionamento", "ComoVerificar": "Confirmar retornos OK de atuadores e sensores; limites de prensa."}, {"PassoOrdem": 11, "OQueVerificar": "Limite pneumático", "ComoVerificar": "Verificar liberação de ar quando acionado; checar atuador e vazamentos."}, {"PassoOrdem": 12, "OQueVerificar": "Relés de acionamento das válvulas", "ComoVerificar": "Testar relés do timer/blocos; substituir se sem pulso ou travados."}]}};

document.addEventListener('DOMContentLoaded', function(){
  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  const toast=$("#toast"); const showToast=(t)=>{toast.textContent=t;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),1500);};
  const autosize=(el)=>{ el.style.height='auto'; el.style.height = el.scrollHeight+'px'; };

  // Lembrar WO/Técnico + Tema
  const LS_WO='assist_wo', LS_TEC='assist_tec', LS_THEME='assist_theme';
  try{
    const w=localStorage.getItem(LS_WO), t=localStorage.getItem(LS_TEC);
    if(w && !$("#inpWO").value) $("#inpWO").value=w;
    if(t && !$("#inpTec").value) $("#inpTec").value=t;
    $("#inpWO").addEventListener('input',e=>{try{localStorage.setItem(LS_WO,e.target.value.trim())}catch(_){}});
    $("#inpTec").addEventListener('input',e=>{try{localStorage.setItem(LS_TEC,e.target.value.trim())}catch(_){}});
  }catch(_){}

  // Tema claro/escuro
  function applyTheme(theme){
    document.documentElement.classList.toggle('dark', theme==='dark');
    const btn=$("#btnTheme");
    if(btn){ btn.textContent='Tema: ' + (theme==='dark'?'Escuro':'Claro'); }
  }
  (function(){
    try{ applyTheme(localStorage.getItem(LS_THEME)||'light'); }
    catch(_){ applyTheme('light'); }
  })();
  $("#btnTheme")?.addEventListener('click',()=>{
    try{
      const cur=localStorage.getItem(LS_THEME)||'light';
      const nxt=(cur==='light'?'dark':'light'); localStorage.setItem(LS_THEME,nxt); applyTheme(nxt);
    }catch(_){
      const isDark=document.documentElement.classList.toggle('dark'); applyTheme(isDark?'dark':'light');
    }
  });

  let ITEMS=[];

  function updateProgress(){
    const total=ITEMS.length;
    const checked=$$("#lista input[type=radio]:checked").length;
    $("#done").textContent=checked;
    $("#bar").style.width=(total?Math.round(100*checked/total):0)+'%';
  }

  function renderChecklist(){
    $("#total").textContent=ITEMS.length;
    $("#done").textContent=0; $("#bar").style.width='0%';
    const wrap=$("#lista"); wrap.innerHTML="";
    ITEMS.forEach((it,idx)=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div class="title">${it.PassoOrdem||idx+1}. ${it.OQueVerificar}</div>
        ${it.ComoVerificar?`<div class="how"><strong>Como verificar:</strong> ${it.ComoVerificar}</div>`:""}
        <div class="small" style="margin-top:6px">
          <label><input type="radio" name="r${idx}" value="OK"> OK</label>
          <label style="margin-left:10px"><input type="radio" name="r${idx}" value="NOK"> NOK</label>
          <label style="margin-left:10px"><input type="radio" name="r${idx}" value="NA"> N.A.</label>
        </div>
        <textarea class="obs" placeholder="Observação (obrigatória se marcar NOK)"></textarea>`;
      wrap.append(el);
    });
    $$("#lista .obs").forEach(t=>{ autosize(t); t.addEventListener('input',()=>{ autosize(t); t.classList.remove('error'); t.closest('.item').classList.remove('error'); }); });
    $("#lista").addEventListener('change',(e)=>{
      if(e.target && e.target.matches('input[type=radio]')){
        const idx=e.target.name.replace('r','');
        const area=$$("#lista .obs")[idx];
        if(e.target.value!=='NOK'){ area.classList.remove('error'); area.closest('.item').classList.remove('error'); }
        updateProgress();
      }
    },{once:false});
  }

  function validarCamposIniciais(){
    const wo=$("#inpWO"), tec=$("#inpTec"), sel=$("#selDef");
    [wo,tec,sel].forEach(el=>el.classList.remove('error'));
    let ok=true;
    if(!wo.value.trim()){ wo.classList.add('error'); if(ok) wo.focus(); ok=false; }
    if(!tec.value.trim()){ tec.classList.add('error'); if(ok) tec.focus(); ok=false; }
    if(!sel.value.trim()){ sel.classList.add('error'); if(ok) sel.focus(); ok=false; }
    if(!ok){ showToast('Preencha WO, Técnico e selecione o defeito.'); }
    return ok;
  }

  function validarNOK(){
    const radios=$$("#lista input[type=radio]");
    const obs=$$("#lista .obs");
    let erros=[];
    ITEMS.forEach((it,i)=>{
      const group=radios.filter(r=>r.name===`r${i}`);
      const sel=group.find(r=>r.checked);
      const v=sel?sel.value:"";
      const o=(obs[i].value||"").trim();
      if(v==="NOK" && o.length===0){
        erros.push(i); obs[i].classList.add('error'); obs[i].closest('.item').classList.add('error');
      }
    });
    if(erros.length){
      const area=$$("#lista .obs")[erros[0]]; area.focus(); area.scrollIntoView({behavior:'smooth',block:'center'});
      showToast('Preencha a Observação onde marcou NOK.'); return false;
    }
    return true;
  }

  // ---- v20: utilitário de yield e buildResumo async (melhor para Chrome mobile) ----
  const microYield = () => new Promise(requestAnimationFrame);

  async function buildResumoAsync(){
    if(!validarCamposIniciais()) return;
    if(!validarNOK()) return;

    const radios = Array.from(document.querySelectorAll('#lista input[type=radio]'));
    const obsEls = Array.from(document.querySelectorAll('#lista .obs'));
    const linhas = [];
    const groupByName = new Map();
    for(const r of radios){
      const name = r.name;
      let arr = groupByName.get(name);
      if(!arr){ arr=[]; groupByName.set(name, arr); }
      arr.push(r);
    }

    for (let i=0;i<ITEMS.length;i++){
      const it = ITEMS[i];
      const group = groupByName.get(`r${i}`) || [];
      const sel = group.find(r=>r.checked);
      const v = sel ? sel.value : "";
      const o = (obsEls[i]?.value || "").trim();
      if(v==="NOK" || o.length>0){
        const obsTxt = o ? ` | Obs.: ${o}` : "";
        linhas.push(`- ${it.OQueVerificar}${obsTxt}`);
      }
      if(i % 10 === 0) await microYield();
    }
    const now=new Date();
    const header=now.toLocaleString();
    const wo=($("#inpWO").value||"").trim();
    const tec=($("#inpTec").value||"").trim();
    const cab=[header,(wo?`WO: ${wo}`:""),(tec?`Técnico: ${tec}`:"")].filter(Boolean).join(" | ");
    const txt=cab+"\n\n"+(linhas.length?linhas.join("\n"):"(sem apontamentos)");
    const out=$("#out"); out.value=txt; autosize(out);
    $("#cardOut").style.display="block";
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  function slugify(s){
    const map = {'Á':'A','À':'A','Â':'A','Ã':'A','Ä':'A','á':'a','à':'a','â':'a','ã':'a','ä':'a',
                 'É':'E','È':'E','Ê':'E','Ë':'E','é':'e','è':'e','ê':'e','ë':'e',
                 'Í':'I','Ì':'I','Î':'I','Ï':'I','í':'i','ì':'i','î':'i','ï':'i',
                 'Ó':'O','Ò':'O','Ô':'O','Õ':'O','Ö':'O','ó':'o','ò':'o','ô':'o','õ':'o','ö':'o',
                 'Ú':'U','Ù':'U','Û':'U','Ü':'U','ú':'u','ù':'u','û':'u','ü':'u',
                 'Ç':'C','ç':'c','Ñ':'N','ñ':'n'};
    return s.split('').map(ch=>map[ch]||ch).join('').replace(/[^A-Za-z0-9\-]+/g,' ').trim().replace(/\s+/g,'_');
  }

  function montarPDF(){
    if(!validarCamposIniciais()) return;
    if(!validarNOK()) return;
    const radios=$$("#lista input[type=radio]");
    const obs=$$("#lista .obs");
    const phTable=$("#phTable"); phTable.innerHTML="";
    ITEMS.forEach((it,i)=>{
      const tr=document.createElement('tr');
      const sel=radios.filter(r=>r.name===`r${i}`).find(r=>r.checked);
      const v=sel?sel.value:"";
      const o=(obs[i].value||"").trim();
      tr.innerHTML=`<td>${it.OQueVerificar}</td><td>${v||"-"}</td><td>${o}</td>`;
      phTable.append(tr);
    });
    const now=new Date();
    $("#phHeader").textContent=now.toLocaleString();
    const woTxt=($("#inpWO").value||"-");
    const tecTxt=($("#inpTec").value||"-");
    $("#phWO").textContent="WO: "+woTxt;
    $("#phTec").textContent="Técnico: "+tecTxt;
    if($("#out").value.trim().length===0){ /* gera resumo se ainda não tiver */ }
    $("#phResumo").textContent=$("#out").value.trim();

    const defeito = ($("#selDef").value||'Defeito').replace(/\s+/g,'-');
    const safeTec = slugify(tecTxt);
    // data/hora BR no nome
    const d=new Date();
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    const hh=String(d.getHours()).padStart(2,'0');
    const mi=String(d.getMinutes()).padStart(2,'0');
    const dataStr=f`${dd}-{mm}-{yyyy}_{hh}h{mi}`
    const fname = `WO-${slugify(woTxt)}_${safeTec}_${defeito}_${dataStr}.pdf`;

    const prevTitle = document.title;
    document.title = fname.replace(/\.pdf$/,'');
    window.print();
    setTimeout(()=>{ document.title = prevTitle; showToast(`PDF salvo como: ${fname}`); }, 800);
  }

  $("#btnGo").addEventListener('click',()=>{
    if(!validarCamposIniciais()) return;
    const def=$("#selDef").value;
    ITEMS=(DATA.itens_por_defeito[def]||[]);
    renderChecklist();
    $("#cardChk").style.display='block';
    $("#cardOut").style.display='none';
    $("#cardChk").scrollIntoView({behavior:'smooth',block:'start'});
  });

  // v20: botão resumo com loading
  const btnResumo = $("#btnResumo");
  btnResumo.addEventListener('click', async ()=>{
    if(btnResumo.hasAttribute('disabled')) return;
    const old = btnResumo.textContent;
    btnResumo.setAttribute('disabled','true');
    btnResumo.textContent = 'Gerando...';
    showToast('Gerando resumo...');
    try{
      await buildResumoAsync();
    } finally {
      btnResumo.textContent = old;
      btnResumo.removeAttribute('disabled');
    }
  });

  $("#btnPDF").addEventListener('click', montarPDF);
  $("#btnCopy").addEventListener('click',()=>{
    const el=$("#out"); const txt=el.value;
    const fallback=()=>{try{el.select(); document.execCommand('copy'); showToast('Copiado!');}catch(e){showToast('Selecione e copie manualmente.');}};
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(()=>showToast('Copiado!')).catch(()=>fallback());
    }else fallback();
  });
  $("#btnReset")?.addEventListener('click',()=>location.reload());

  // Botão "Limpar": reseta TUDO (menos o tema)
  $("#btnClear")?.addEventListener('click',()=>{
    try{
      localStorage.removeItem(LS_WO); localStorage.removeItem(LS_TEC);
    }catch(_){}
    $("#inpWO").value=""; $("#inpTec").value="";
    $("#selDef").value="";
    $("#lista").innerHTML="";
    $("#cardChk").style.display='none';
    $("#done").textContent="0"; $("#total").textContent="0"; $("#bar").style.width="0%";
    $("#out").value=""; autosize($("#out"));
    $("#cardOut").style.display='none';
    window.scrollTo({top:0,behavior:'smooth'});
    showToast('Tudo limpo.');
  });

  $("#inpWO").addEventListener('input', e=> e.target.classList.remove('error'));
  $("#inpTec").addEventListener('input', e=> e.target.classList.remove('error'));
  $("#selDef").addEventListener('change', e=> e.target.classList.remove('error'));
});
</script>
</body>
</html>
